
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using Rails 4.0.0.beta - cloudkickr</title>
  <meta name="author" content="Bent Cardan">

  
  <meta name="description" content="Rails 4.0.0.beta compiled for production feels faster than Rails 3 to me, especially when proxied by Nginx and initialized with Puma. First I clone &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cloudkickr.github.com/blog/2012/07/29/rails-4.0.0.beta">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="cloudkickr" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/"><img src="http://s3.amazonaws.com/cloudkickr/assets/images/clouds.png"></a></h1>
  
    <h2>giving you a taste.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cloudkickr.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about/">about</a></li>
  <li><a href="/">blog</a></li>
  <li><a href="/blog/archives">archives</a></li>
  


</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using Rails 4.0.0.beta</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-29T05:02:00-04:00" pubdate data-updated="true">Jul 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Rails 4.0.0.beta compiled for production feels faster than Rails 3 to me, especially when proxied by Nginx and initialized with Puma. First I clone the master branch of Rails on Github.  There&#8217;s a multithread option, and background process queue option available by default in the Rails 4 initializers. You&#8217;ll need ruby 1.9.3 and probably a public key linked to your github, as usual in all things of this nature.</p>

<figure class='code'><figcaption><span>pull down the master branch - clone.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git clone git://github.com/rails/rails.git
</span></code></pre></td></tr></table></div></figure>


<p>Generate a Rails 4 beta app from the freshly cloned repo.</p>

<figure class='code'><figcaption><span>generate the rails app - rails.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>rails/railties/bin/rails new myrails4app --edge --skip-bundle --skip-test-unit
</span></code></pre></td></tr></table></div></figure>


<p>Wait to run bundle for an opportunity to isolate and to manage gem dependencies.</p>

<figure class='code'><figcaption><span>rvm - rvmrc.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>myrails4app
</span><span class='line'><span class="nv">$ </span>rvm --rvmrc --create 1.9.3@myrails4app
</span></code></pre></td></tr></table></div></figure>


<p>Add the puma gem for multithreaded processing.</p>

<figure class='code'><figcaption><span>adding puma - Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'puma'</span></code></pre></td></tr></table></div></figure>


<p>If you&#8217;re going with a relatoinal database, kick up your pool: to higher parameters in the database.yml file, absolutely the higher pool is ideal, set it pool: 16. Puma defaults to 16 threads when no configuration is specified. Assuming modern server hardware equipped with multi-core processors, this means 16 request/response threads by default will be handled, routed and delivered by the app over one puma process.</p>

<figure class='code'><figcaption><span>inside the config directory - database.yml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db/development.sqlite3</span>
</span><span class='line'><span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">16</span>
</span></code></pre></td></tr></table></div></figure>


<p>A potential block arises where the database is unable to write at the speed of the incoming request/response thread. We call that blocking I/O. If we&#8217;re using Active Record, we might opt for PostgreSQL. Redis would be among the best options available despite its single threaded architecture. In fact, we commit an error to dismiss a Puma/Redis combination on the basis of Puma&#8217;s multithreaded and Redis&#8217; single-threaded difference alone.</p>

<p>Redis was built for pipelining. A Request/Response server can be implemented so that it is able to process new requests even if the client didn&#8217;t already read the old responses. This way it is possible to send multiple commands to the server without waiting for the replies at all, and finally read the replies in a single step. Redis Pipelining avoids I/O blocking, however it must be supported by available memory. Redis stores data in memory and later writes to disk.</p>

<p>Go bigger when you let puma loose if you like. Be mindful that your default database.yml limits threading explicitly by pool size and more implicity at the limit of its ability to write and return data from threads. Pool params represents max simultaneous (or close to it) data transactions into or out of the database. In general we want to increase the size of our pool wherever possible. Set your gems and run Bundle. Beyond this step it&#8217;s typical that you&#8217;ll need to nudge on rails executables using &#8216;bundle exec&#8217; or try to pass in &#8211;binstubs if it can prevent the need for &#8216;bundle exec&#8217; if you ever rake migrations or &#8216;rails s&#8217;.</p>

<figure class='code'><figcaption><span>generate the rails app - bundle.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>bundle install --binstubs
</span></code></pre></td></tr></table></div></figure>


<p>Hit the <a href="http://edgeguides.rubyonrails.org/">edge guides</a> and google all the errors you don&#8217;t have a handle on. Check out the depth of content available in Rails error messaging, and check out the new exception handling interface in development mode.</p>

<p>After generating my first controller I didn&#8217;t see the new syntax contraints awaiting throughout the config/routes.rb file. Routes complained about how I matched the controller action using the older => syntax perfectly fine in rails 3.2.7. I thought it was cool Rails 4 asked me to revise this syntax and preface all GET requests with GET. Not such a bad idea&#8230;</p>

<p>Play with the process queue initializer setting. Uncomment config.threadsafe! in the production.rb file to test multithreads with puma. If you do this, watch out for closely coupled procedural calculations. Anything coupled is suspect and ought to be refactored anyway. Look out for object ordering or dependent, interwoven actions generated in the controller, (I&#8217;m thinking like ActiveRecord&#8217;s build method available for relating decoupled models for shopping cart and order relationships .. so watch out e-commerce cart models and controllers). In a multithreaded instance the app will begin to degrade meanful return values and will risk object integrity where thread simultaneity is lazily tolerated throughout the course of it routing. To protect business critical object-integrity across the app we might take note of these paterns and wrap them in the mutex class in order to shift the alignment of threads into a data-safe, linear approach. I think mutexing on multi-threads is problematic because it creates tremendous bottleneck opportuntiy. People hate waiting for slow web apps. Forget the mutex class, the answer is decoupled design through refactoring. RSpec can predict results and might help reign over potentially unmanageable complexity or app retardation there. :)</p>

<p>I think a great way to observe an app like this in production is to proxy it with nginx on a remote server, a VPS. I&#8217;d proxy-pass the puma process upstream at the unix socket. I like when all the rails apps running on the server are proxied by their own nginx.conf&#8211;this level of organization in deployment is possible because the centralized proxy setting configuration file references a nearby directory with by an include.</p>

<p>Through a symbolic link we can relay data between directories about the nginx proxy server. Our communication is reminiscent of the PHP include.</p>

<figure class='code'><figcaption><span>symbolic link within sites-enabled directory to hit app&#8217;s nginx.conf - link.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo ln -s /home/myusername/allmyedgeapps/myrails4app/config/nginx.conf myrails4app.com
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>my_distilled_nginx - nginx.conf.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>upstream myrails4app.com <span class="o">{</span>server unix:/tmp/myrails4app.sock <span class="nv">fail_timeout</span><span class="o">=</span>0;<span class="o">}</span>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'> server_name myrails4app.com www.myrails4app.com;
</span><span class='line'> root /home/myusername/allmyedgeapps/myrails4app/public;
</span><span class='line'> try_files <span class="nv">$uri</span>/index.html <span class="nv">$uri</span> @myrails4app.com;
</span><span class='line'> location @myrails4app.com <span class="o">{</span>
</span><span class='line'>  proxy_redirect off;
</span><span class='line'>  proxy_pass http://myrails4app.com;
</span><span class='line'> <span class="o">}</span>
</span><span class='line'> error_page 500 502 503 504 /500.html;
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nginx will use port 80 by default so I wouldn&#8217;t even specify that in the nginx.conf files across all the rails apps sharing port 80 at the proxy outset. Now unleash and initialize puma. Keep in mind that all its incoming/outgoing request/response objects are proxied and passed to and from nginx. Restart Nginx if you have not done so already so that it picks up any changes made to CSS or JavaScript. Make sure the hand-off occurs at the same place (the shared unix socket) or else they won&#8217;t be able to meet up and pass respective objects in and out of the app.</p>

<figure class='code'><figcaption><span>let puma run multi-thread from the root directory of your rails app - puma.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>puma -b unix:///tmp/myrails4app.sock
</span></code></pre></td></tr></table></div></figure>


<p>Yea I know we&#8217;re not supposed to emphasize configuration over convention but most of the sequence here is arbitrary. After the sym link is made you restart nginx but the rest of it could occur freely either before or after the unix socket is held down at puma initialization. Once proxy and socket are up go check your example.com, we used myrails4app.com in this discussion. You might forward domains or concatenate subdomians for any number of rails apps pointed to a single IP address, or the IPv6 address too if possible. As Rails developers I know its a little unkosher to mention lower level IPv6, but come on, drawing from all this I hope you have a sense for the possiblities and found this post useful. Ryan Bates taught me how to do most of this puma stuff and he has a lot more good ideas to watch at railscast.com!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bent Cardan</span></span>

      








  


<time datetime="2012-07-29T05:02:00-04:00" pubdate data-updated="true">Jul 29<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>, <a class='category' href='/blog/categories/web-development/'>Web Development</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://cloudkickr.github.com/blog/2012/07/29/rails-4.0.0.beta/" data-via="bcardan" data-counturl="http://cloudkickr.github.com/blog/2012/07/29/rails-4.0.0.beta/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/07/29/jquery-effects/" title="Previous Post: some jQuery effects">&laquo; some jQuery effects</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/29/rails-4.0.0.beta/">Using Rails 4.0.0.beta</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/29/jquery-effects/">some jQuery effects</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/19/sopa-whats-up-with-that/">SOPA: What's up with that?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/04/Search-Engine/">Search Engine in development</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/31/happy-new-year/">Happy New Year!</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/bcardan">@bcardan</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bcardan',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bcardan", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bcardan" class="twitter-follow-button" data-show-count="false">Follow @bcardan</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Bent Cardan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
